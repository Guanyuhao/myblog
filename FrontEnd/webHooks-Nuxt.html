<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>webhooks-nuxt | Guanyuhao</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/myblog/yuhao.jpg">
    <meta name="description" content="365天，每天都是一天">
    <link rel="preload" href="/myblog/assets/css/0.styles.addcae8b.css" as="style"><link rel="preload" href="/myblog/assets/js/app.8f7b38c9.js" as="script"><link rel="preload" href="/myblog/assets/js/2.77eef88a.js" as="script"><link rel="preload" href="/myblog/assets/js/10.8920f297.js" as="script"><link rel="prefetch" href="/myblog/assets/js/11.825504ce.js"><link rel="prefetch" href="/myblog/assets/js/12.23c270d1.js"><link rel="prefetch" href="/myblog/assets/js/13.3588c5ac.js"><link rel="prefetch" href="/myblog/assets/js/14.75f678ba.js"><link rel="prefetch" href="/myblog/assets/js/15.324af5a0.js"><link rel="prefetch" href="/myblog/assets/js/16.b94f6170.js"><link rel="prefetch" href="/myblog/assets/js/17.733b97ac.js"><link rel="prefetch" href="/myblog/assets/js/18.6a528390.js"><link rel="prefetch" href="/myblog/assets/js/19.aad7ff28.js"><link rel="prefetch" href="/myblog/assets/js/20.7ff74902.js"><link rel="prefetch" href="/myblog/assets/js/21.33578e43.js"><link rel="prefetch" href="/myblog/assets/js/22.d5f7c29a.js"><link rel="prefetch" href="/myblog/assets/js/23.9319b590.js"><link rel="prefetch" href="/myblog/assets/js/24.17ba05a0.js"><link rel="prefetch" href="/myblog/assets/js/25.a40fcc87.js"><link rel="prefetch" href="/myblog/assets/js/26.a949dd99.js"><link rel="prefetch" href="/myblog/assets/js/27.96ec2423.js"><link rel="prefetch" href="/myblog/assets/js/28.4dc66495.js"><link rel="prefetch" href="/myblog/assets/js/29.fafac4e3.js"><link rel="prefetch" href="/myblog/assets/js/3.24e45a87.js"><link rel="prefetch" href="/myblog/assets/js/30.f0ede80e.js"><link rel="prefetch" href="/myblog/assets/js/4.533eb093.js"><link rel="prefetch" href="/myblog/assets/js/5.e254a985.js"><link rel="prefetch" href="/myblog/assets/js/6.d6277420.js"><link rel="prefetch" href="/myblog/assets/js/7.84a5220b.js"><link rel="prefetch" href="/myblog/assets/js/8.d8d07367.js"><link rel="prefetch" href="/myblog/assets/js/9.29867942.js">
    <link rel="stylesheet" href="/myblog/assets/css/0.styles.addcae8b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myblog/" class="home-link router-link-active"><!----> <span class="site-name">Guanyuhao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试" class="dropdown-title"><span class="title">面试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/cs/" class="nav-link">
  计算机通识
</a></li><li class="dropdown-item"><!----> <a href="/myblog/FrontEnd/" class="nav-link router-link-active">
  前端
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/guanyuhao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试" class="dropdown-title"><span class="title">面试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/cs/" class="nav-link">
  计算机通识
</a></li><li class="dropdown-item"><!----> <a href="/myblog/FrontEnd/" class="nav-link router-link-active">
  前端
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/guanyuhao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/myblog/FrontEnd/" aria-current="page" class="sidebar-link">前端</a></li><li><a href="/myblog/FrontEnd/Vue.html" class="sidebar-link">Vue</a></li><li><a href="/myblog/FrontEnd/webHooks-Nuxt.html" aria-current="page" class="active sidebar-link">webhooks-nuxt</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myblog/FrontEnd/webHooks-Nuxt.html#一、使用-create-nuxt-app-脚手架创建项目" class="sidebar-link">一、使用 create-nuxt-app 脚手架创建项目</a></li><li class="sidebar-sub-header"><a href="/myblog/FrontEnd/webHooks-Nuxt.html#二、修改-package-json-中的-npm-scripts" class="sidebar-link">二、修改 package.json 中的 npm scripts</a></li><li class="sidebar-sub-header"><a href="/myblog/FrontEnd/webHooks-Nuxt.html#三、添加-webhooks-接口" class="sidebar-link">三、添加 Webhooks 接口</a></li><li class="sidebar-sub-header"><a href="/myblog/FrontEnd/webHooks-Nuxt.html#四、如何无缝更新服务" class="sidebar-link">四、如何无缝更新服务</a></li><li class="sidebar-sub-header"><a href="/myblog/FrontEnd/webHooks-Nuxt.html#五、部署公钥管理" class="sidebar-link">五、部署公钥管理</a></li><li class="sidebar-sub-header"><a href="/myblog/FrontEnd/webHooks-Nuxt.html#六、docker-部署" class="sidebar-link">六、Docker 部署</a></li><li class="sidebar-sub-header"><a href="/myblog/FrontEnd/webHooks-Nuxt.html#七、留个后门" class="sidebar-link">七、留个后门</a></li></ul></li><li><a href="/myblog/FrontEnd/webpack说明.html" class="sidebar-link">聊一聊 webpack</a></li><li><a href="/myblog/FrontEnd/垃圾回收机制.html" class="sidebar-link">垃圾回收机制</a></li><li><a href="/myblog/FrontEnd/安全.html" class="sidebar-link">安全</a></li><li><a href="/myblog/FrontEnd/性能.html" class="sidebar-link">性能</a></li><li><a href="/myblog/FrontEnd/框架通识.html" class="sidebar-link">框架通识</a></li><li><a href="/myblog/FrontEnd/浏览器.html" class="sidebar-link">浏览器</a></li><li><a href="/myblog/FrontEnd/知识回顾.html" class="sidebar-link">知识回顾</a></li><li><a href="/myblog/FrontEnd/节流和防抖.html" class="sidebar-link">防抖和节流</a></li><li><a href="/myblog/FrontEnd/跨域以及解决.html" class="sidebar-link">跨域以及解决</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webhooks-nuxt"><a href="#webhooks-nuxt" class="header-anchor">#</a> webhooks-nuxt</h1> <blockquote><p>借助 Webhooks 实现 Vue SSR 项目的自动化部署</p></blockquote> <blockquote><p>原文 https://github.com/HaoChuan9421/webhooks-nuxt-demo</p></blockquote> <h2 id="一、使用-create-nuxt-app-脚手架创建项目"><a href="#一、使用-create-nuxt-app-脚手架创建项目" class="header-anchor">#</a> 一、使用 <a href="https://zh.nuxtjs.org/guide/installation" target="_blank" rel="noopener noreferrer">create-nuxt-app<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 脚手架创建项目</h2> <p>创建时的各种选项如下图所示，你可以根据自己项目的实际情况进行选择，但 <code>server framework</code> 请选择 <code>express</code>，本文也将以 <code>express</code> 作为服务端框架展开介绍。</p> <h2 id="二、修改-package-json-中的-npm-scripts"><a href="#二、修改-package-json-中的-npm-scripts" class="header-anchor">#</a> 二、修改 package.json 中的 npm scripts</h2> <p><code>Nuxt</code> 脚手架生成的项目，默认在生产环境下需要先执行 <code>npm run build</code> 构建代码，然后再执行 <code>npm start</code> 启动服务，这略显繁琐，也不利于自动部署、重新构建等工作的展开，这里将两者的功能合二为一，执行 <code>npm start</code>，即可在<a href="https://zh.nuxtjs.org/api/nuxt" target="_blank" rel="noopener noreferrer">编码中使用构建<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>并启动服务。得益于 <code>Nuxt</code> 配置中的 <a href="https://zh.nuxtjs.org/api/configuration-dev" target="_blank" rel="noopener noreferrer">dev 参数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, 在不同的环境下（<code>NODE_ENV</code>），即使使用的都是 <code>new Builder(nuxt).build()</code> 来进行构建，但由于 <code>dev</code> 参数的不同，<code>Nuxt</code> 的构建行为也会相应的不同并进行针对性的优化。这里生产环境（<code>production</code>）下启动服务也不再是通过 <code>node</code> 命令而是使用 <a href="https://www.npmjs.com/package/nodemon" target="_blank" rel="noopener noreferrer">nodemon<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，它用于监听 <code>server/index.js</code> 文件的变化，在 <code>server/index.js</code> 更新时可以自动重启服务。调整前后的 <code>npm scripts</code> 如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 前</span>
<span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=development nodemon server/index.js --watch server&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nuxt build&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=production node server/index.js&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 后</span>
<span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=development nodemon server/index.js --watch server&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=production nodemon server/index.js --watch server&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同时，删除 <code>server/index.js</code> 中原本的条件判断：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//if (config.dev) {</span>
<span class="token keyword">const</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Builder</span><span class="token punctuation">(</span>nuxt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//}</span>
</code></pre></div><p>调整之后，执行 <code>npm run dev</code>，就会在 3000 端口启动一个有代码热替换（<code>HMR</code>）等功能的一个开发（<code>development</code>）服务，而执行 <code>npm start</code> 就会构建出压缩后的代码，并启动一个带 <code>gzip</code> 压缩等功能的生产（<code>production</code>）服务。</p> <h2 id="三、添加-webhooks-接口"><a href="#三、添加-webhooks-接口" class="header-anchor">#</a> 三、添加 Webhooks 接口</h2> <p><code>Webhooks</code> 是什么？简单来说：假如你向一个仓库添加了 <code>Webhook</code> ，那么当你 <code>push</code> 代码时，<code>git</code> 服务器就会自动向你指定的地址，发送一个带有更新信息（<code>payload</code>）的 <code>post</code> 请求。了解更多，请阅读 <a href="https://developer.github.com/webhooks/" target="_blank" rel="noopener noreferrer">GitHub 关于 Webhooks 的介绍文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或者 <a href="https://gitee.com/help/categories/40" target="_blank" rel="noopener noreferrer">码云的文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。由于我们使用了 <code>express</code> 来创建 <code>http</code> 服务，所以我们可以像这样方便的添加一个接口，用于接收来自 <code>git</code> 服务器的 <code>post</code> 请求：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">...</span>
<span class="token comment">// 订阅来自 git 服务器 的 Webhooks 请求（post 类型）</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/webhooks'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用 secret token 对该 API 的调用进行鉴权, 详细文档: https://developer.github.com/webhooks/securing/</span>
  <span class="token keyword">const</span> <span class="token constant">SECRET_TOKEN</span> <span class="token operator">=</span> <span class="token string">'b65c19b95906e027c5d8'</span><span class="token punctuation">;</span>
  <span class="token comment">// 计算签名</span>
  <span class="token keyword">const</span> signature <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sha1=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>crypto
    <span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">,</span> <span class="token constant">SECRET_TOKEN</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token comment">// 验证签名和 Webhooks 请求中的签名是否一致</span>
  <span class="token keyword">const</span> isValid <span class="token operator">=</span> signature <span class="token operator">===</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'x-hub-signature'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果验证通过，返回成功状态并更新服务</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Authorized'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">upgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 鉴权失败，返回无权限提示</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Permission Denied'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre></div><p>这里的 <code>app</code> 是一个 <code>express</code> 应用，我们通过了 <code>Node</code> 的 <code>crypto</code> 模块计算签名并和 <code>Webhooks</code> 请求中的签名比对来进行鉴权，以保证接口调用的安全性（这里的能够获取到 <code>Webhooks</code> 请求的请求体 —— <code>req.body</code> 是由于使用了 <a href="https://www.npmjs.com/package/body-parser" target="_blank" rel="noopener noreferrer">body-parser 中间件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。如果鉴权通过则返回成功状态，并执行 <code>upgrade</code> 函数来更新服务，如果鉴权失败，则返回无权限提示。同时，你需要向仓库添加 <code>Webhook</code>，如下图：</p> <img src="https://github.com/HaoChuan9421/webhooks-nuxt-demo/blob/master/assets/add_webhooks.png" style="width:100%;"> <h2 id="四、如何无缝更新服务"><a href="#四、如何无缝更新服务" class="header-anchor">#</a> 四、如何无缝更新服务</h2> <p>如果你的项目已经在 <code>http://www.example.com/</code> 下启动成功，那么当你每次向 <code>GitHub</code> 仓库 <code>push</code> 代码时，你的接口都会收到一个来自 <code>GitHub</code> 的 <code>post</code> 请求，并在鉴权通过后执行 <code>upgrade</code> 函数来更新服务。关于如何在服务器上启动项目我们按下不表，先介绍 <code>upgrade</code> 函数都做了什么。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 从 git 服务器拉取最新代码，更新 npm 依赖，并重新构建项目
 */</span>
<span class="token keyword">function</span> <span class="token function">upgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">&quot;git pull -f &amp;&amp; npm install&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>execCommand</code> 函数如下，这里我们使用了 <code>Node</code> 的 <a href="https://nodejs.org/api/child_process.html#child_process_child_process_exec_command_options_callback" target="_blank" rel="noopener noreferrer">child_process<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块，用以创建子进程，来执行拉取代码， 更新 <code>npm</code> 依赖等命令：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> execSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;child_process&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 创建子进程，执行命令
 * @param {String} command 需要执行的命令
 * @param {Boolean} reBuild 是否重新构建应用
 * @param {Function} callback 执行命令后的回调
 */</span>
<span class="token keyword">function</span> <span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token parameter">command<span class="token punctuation">,</span> reBuild<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  command <span class="token operator">&amp;&amp;</span> <span class="token function">execSync</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据配置文件，重新构建项目</span>
  reBuild <span class="token operator">&amp;&amp;</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>build</code> 函数，会根据配置文件，重新构建项目，这里的 <code>upgrading</code> 是一个标记应用是否正在升级的 <code>flag</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 根据配置，构建项目
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>upgrading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  upgrading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// 导入 Nuxt.js 参数</span>
  <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../nuxt.config.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据环境变量 NODE_ENV，设置 config.dev 的值</span>
  config<span class="token punctuation">.</span>dev <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化 Nuxt.js</span>
  <span class="token keyword">const</span> nuxt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Nuxt</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 构建应用，得益于环境变量 NODE_ENV，在开发环境和生产环境下这个构建的表现会不同</span>
  <span class="token keyword">const</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Builder</span><span class="token punctuation">(</span>nuxt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 等待构建</span>
  <span class="token keyword">await</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 构建完成后，更新 render 中间件</span>
  render <span class="token operator">=</span> nuxt<span class="token punctuation">.</span>render<span class="token punctuation">;</span>
  <span class="token comment">// 将 flag 置反</span>
  upgrading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果是初次构建，则创建 http server</span>
  server <span class="token operator">||</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>createServer</code> 函数如下，这里有两个全局变量，<code>render</code> 和 <code>server</code>，其中 <code>render</code> 变量保存了最新构建后的 <code>nuxt.render</code> 中间件，而 <code>server</code> 变量是应用的 <code>http server</code> 实例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 创建应用的 http server
 */</span>
<span class="token keyword">function</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 向 express 应用添加 nuxt 中间件，重新构建之后，中间件会发生变化</span>
  <span class="token comment">// 这种处理方式的好处就在于 express 使用的总是最新的 nuxt.render</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 启动服务</span>
  server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    consola<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server listening on http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      badge<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>访问<a href="http://gitlab.corp.elensdata.com/guancong/llpssr/server/index.js" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，查看完整的 <code>server/index.js</code> 文件。但这里存在一个问题 ☝️，就是每次执行 <code>build</code> 函数，重新构建时，由于 <code>Nuxt</code> 会删除上一次构建生成的文件（清空<code>.nuxt/dist/client</code> 和 <code>.nuxt/dist/server</code> 文件夹），而构建完成之后才会生成新的文件，那么如果用户恰好在这个空档期访问网站怎么办？一种解决方案是干预 <code>webpack</code> 的这种行为，不去清空这两个文件夹，不过我目前没有找到 <code>Nuxt</code> 中可以修改这个配置的地方（欢迎评论），另一种解决方案就是在项目重新构建的时候，给用户返回一个友好的提示页，告诉他系统正在升级中。这也是我设置 <code>upgrading</code> 变量来标记应用是否正在升级中的意义所在，下面这段代码将展示，如果实现这种效果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 拦截所以 get 请求，如果系统正在升级中，则返回提示页面</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>upgrading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token string">&quot;./upgrading.html&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> root<span class="token operator">:</span> __dirname <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>要说明的一点是：<code>app.get('*', ...)</code> 必须写在前面，你可以在<a href="https://expressjs.com/en/4x/api.html#app.use" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的 <code>Description</code> 中找到解释。如此一来，当用户恰好在应用重新构建时访问网站，就会出现一个友好的提示页，而当构建完成后，用户再次访问网站，就是一个升级后的应用，整个过程，服务器始终是保持在线的状态，<code>http server</code> 并没有停止或者重启。</p> <p>至此，你已经可以把项目代码上传到 <code>GitHub</code> 或者 <strong>码云</strong>了（不同的服务商对 <code>Webhooks</code> 的鉴权方式可能会有所不同，你需要参考他们的文档对接口的鉴权方式进行一点调整）。</p> <h2 id="五、部署公钥管理"><a href="#五、部署公钥管理" class="header-anchor">#</a> 五、部署公钥管理</h2> <p>为私有项目添加部署公钥，使得项目在服务器上或者在 <code>Docker</code> 中可以安全的进行代码克隆和后续的拉取更新，<a href="https://gitee.com/help/articles/4181#article-header0" target="_blank" rel="noopener noreferrer">参考链接 1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/#generating-a-new-ssh-key" target="_blank" rel="noopener noreferrer">参考链接 2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。这里以 <code>GitHub</code> 为例进行介绍：</p> <ol><li><p>生成一个 <code>GitHub</code> 用的 <code>SSH key</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>ssh-keygen -t rsa -C <span class="token string">'yourEmail'</span> -f ~/.ssh/github_id_rsa
</code></pre></div><p>一般情况下，是不需要使用 <code>-f ~/.ssh/github_id_rsa</code> 来指定生成 <code>SSH Key</code> 的文件名的，默认生成的是 <code>id_rsa</code>。但考虑到一台机器同时使用不同的 <code>git</code> 服务器的可能性，所以这里对生成的 <code>SSH key</code> 名称进行了自定义。这里的邮箱是你的 <code>git</code> 服务器 （<code>GitHub</code>）登录邮箱。</p></li> <li><p>在 <code>~/.ssh</code> 目录下新建一个 config 文件，添加如下内容，<a href="https://www.ssh.com/ssh/config/" target="_blank" rel="noopener noreferrer">参考文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># github</span>
Host github.com
HostName github.com
StrictHostKeyChecking no
PreferredAuthentications publickey
IdentityFile ~/.ssh/github_id_rsa
</code></pre></div><p>其中 <code>Host</code> 和 <code>HostName</code> 填写 <code>git</code> 服务器的域名，<code>IdentityFile</code> 指定私钥的路径，<code>StrictHostKeyChecking</code> 设置为 <code>no</code> 可以跳过下图中 <code>(yes/no)</code> 的询问，这一点对于 <code>Docker</code> 流畅的创建镜像很有必要（否则可能要写 <code>expect</code> 脚本），当然你也可以通过执行 <code>ssh-keyscan github.com &gt; ~/.ssh/known_hosts</code> 将 <code>host keys</code> 提前添加到 <code>known_hosts</code> 文件中。</p></li> <li><p>在项目仓库添加部署公钥</p></li></ol> <ol start="4"><li><p>测试公钥是否可用</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">ssh</span> -T git@github.com
</code></pre></div></li></ol> <h2 id="六、docker-部署"><a href="#六、docker-部署" class="header-anchor">#</a> 六、Docker 部署</h2> <h4 id="_1-安装-docker-ce-阿里云-ubuntu-18-04-已亲试"><a href="#_1-安装-docker-ce-阿里云-ubuntu-18-04-已亲试" class="header-anchor">#</a> 1. <a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" target="_blank" rel="noopener noreferrer">安装 Docker CE<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (阿里云 Ubuntu 18.04 已亲试)</h4> <h4 id="_2-创建-dockerfile"><a href="#_2-创建-dockerfile" class="header-anchor">#</a> 2. 创建 Dockerfile</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 添加 node 镜像，:8 是指定 node 的版本，默认会拉取最新的</span>
FROM node:8
<span class="token comment"># 定义 SSH 私钥变量</span>
ARG ssh_prv_key
<span class="token comment"># 定义 SSH 公钥变量</span>
ARG ssh_pub_key
<span class="token comment"># 在 /home 下创建名为 webhooks-nuxt-demo 的文件夹</span>
RUN <span class="token function">mkdir</span> -p /home/webhooks-nuxt-demo
<span class="token comment"># 为 RUN, CMD 等命令指定工作区</span>
WORKDIR /home/webhooks-nuxt-demo
<span class="token comment"># 创建 .ssh 目录</span>
RUN <span class="token function">mkdir</span> -p /root/.ssh
<span class="token comment"># 生成 github_id_rsa、github_id_rsa.pub 和 config 文件</span>
RUN <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$ssh_prv_key</span>&quot;</span> <span class="token operator">&gt;</span> /root/.ssh/github_id_rsa <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$ssh_pub_key</span>&quot;</span> <span class="token operator">&gt;</span> /root/.ssh/github_id_rsa.pub <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Host github.com<span class="token entity" title="\n">\n</span>HostName github.com<span class="token entity" title="\n">\n</span>StrictHostKeyChecking no<span class="token entity" title="\n">\n</span>PreferredAuthentications publickey<span class="token entity" title="\n">\n</span>IdentityFile /root/.ssh/github_id_rsa&quot;</span> <span class="token operator">&gt;</span> /root/.ssh/config
<span class="token comment"># 修改私钥的用户权限</span>
RUN <span class="token function">chmod</span> <span class="token number">600</span> /root/.ssh/github_id_rsa
<span class="token comment"># 克隆远端 git 仓库代码到工作区，注意最后的 . 不能省略</span>
RUN <span class="token function">git</span> clone git@github.com:HaoChuan9421/webhooks-nuxt-demo.git <span class="token builtin class-name">.</span>
<span class="token comment"># 安装依赖</span>
RUN <span class="token function">npm</span> <span class="token function">install</span>
<span class="token comment"># 对外暴露 3000 端口</span>
EXPOSE <span class="token number">3000</span>
<span class="token comment"># 启动时的执行脚本</span>
CMD <span class="token function">npm</span> start
</code></pre></div><h4 id="_3-创建-docker-image"><a href="#_3-创建-docker-image" class="header-anchor">#</a> 3. 创建 Docker Image</h4> <p>通过 <code>cat</code> 命令读取之前创建的 <code>SSH</code> 公钥和私钥的内容并作为变量传递给 <code>Docker</code>。由于 <code>build</code> 镜像的过程需要执行 <code>git clone</code> 和 <code>npm install</code>，取决于机器性能和带宽，可能需要花费一定的时间。一个正常的 <code>build</code> 过程如下图：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker build <span class="token punctuation">\</span>
-t webhooks-nuxt-demo <span class="token punctuation">\</span>
--build-arg <span class="token assign-left variable">ssh_prv_key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> ~/.ssh/github_id_rsa<span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">\</span>
--build-arg <span class="token assign-left variable">ssh_pub_key</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> ~/.ssh/github_id_rsa.pub<span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">\</span>
<span class="token builtin class-name">.</span>
</code></pre></div><img src="https://github.com/HaoChuan9421/webhooks-nuxt-demo/blob/master/assets/build-image.png" style="width:200px;"> <h4 id="_4-启动容器"><a href="#_4-启动容器" class="header-anchor">#</a> 4. 启动容器</h4> <p>在后台启动容器，并把容器内的 3000 端口 发布到主机的 80 端口。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> docker run -d -p <span class="token number">80</span>:3000 webhooks-nuxt-demo
</code></pre></div><h4 id="_5-进入执行中的容器"><a href="#_5-进入执行中的容器" class="header-anchor">#</a> 5. 进入执行中的容器</h4> <p>必要的时候可以进入容器中执行一些操作：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 列出所有容器</span>
docker container <span class="token function">ls</span> -a
<span class="token comment"># 进入指定的容器中</span>
docker <span class="token builtin class-name">exec</span> -i -t 容器名称或者容器ID <span class="token function">bash</span>
</code></pre></div><h2 id="七、留个后门"><a href="#七、留个后门" class="header-anchor">#</a> 七、留个后门</h2> <p>有时候我们可能需要执行一些命令，来对项目进行更佳灵活的操作，比如切换项目的分支、进行版本回滚等。但如果只是为了执行一行命令就需要连接服务器，再进入容器内，难免有些繁琐，启发于 <code>Webhooks</code>，我们不妨留个后门 👻：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 预留一个接口，必要时可以通过调取这个接口，来执行命令。</span>
<span class="token comment">// 如：通过发起下面这个 AJAX 请求，来进行 npm 包的升级并重新构建项目。</span>
<span class="token comment">// var xhr = new XMLHttpRequest();</span>
<span class="token comment">// xhr.open('post', '/command');</span>
<span class="token comment">// xhr.setRequestHeader('access_token', 'b65c19b95906e027c5d8');</span>
<span class="token comment">// xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');</span>
<span class="token comment">// xhr.send(</span>
<span class="token comment">//   JSON.stringify({</span>
<span class="token comment">//     command: 'npm update',</span>
<span class="token comment">//     reBuild: true</span>
<span class="token comment">//   })</span>
<span class="token comment">// );</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/command&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果必要的话可以进行更严格的鉴权，这里只是一个示范</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&quot;access_token&quot;</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;b65c19b95906e027c5d8&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行命令，并返回命令的执行结果</span>
    <span class="token function">execCommand</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>command<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>reBuild<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
      <span class="token parameter">error<span class="token punctuation">,</span>
      stdout<span class="token punctuation">,</span>
      stderr</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stdout<span class="token punctuation">,</span> stderr <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果是纯粹的重新构建，没有需要执行的命令，直接结束请求，不需要等待命令的执行结果</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>command <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>reBuild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;Authorized and rebuilding!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Permission Denied&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/3/2019, 8:40:11 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/myblog/FrontEnd/Vue.html" class="prev">
        Vue
      </a></span> <span class="next"><a href="/myblog/FrontEnd/webpack说明.html">
        聊一聊 webpack
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/myblog/assets/js/app.8f7b38c9.js" defer></script><script src="/myblog/assets/js/2.77eef88a.js" defer></script><script src="/myblog/assets/js/10.8920f297.js" defer></script>
  </body>
</html>
